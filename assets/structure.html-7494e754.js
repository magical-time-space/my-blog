import{_ as c,X as r,Y as l,a1 as d,Z as e,$ as n,a0 as s,a5 as i,a4 as a,E as t}from"./framework-d8252107.js";const u={},k=a(`<p>在上一节我们实现了一个极简的<code>useState</code>，了解了<code>Hooks</code>的运行原理。</p><p>本节我们讲解<code>Hooks</code>的数据结构，为后面介绍具体的<code>hook</code>打下基础。</p><h2 id="dispatcher" tabindex="-1"><a class="header-anchor" href="#dispatcher" aria-hidden="true">#</a> dispatcher</h2><p>在上一节的极简<code>useState</code>实现中，使用<code>isMount</code>变量区分<code>mount</code>与<code>update</code>。</p><p>在真实的<code>Hooks</code>中，组件<code>mount</code>时的<code>hook</code>与<code>update</code>时的<code>hook</code>来源于不同的对象，这类对象在源码中被称为<code>dispatcher</code>。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// mount时的Dispatcher</span>
<span class="token keyword">const</span> <span class="token literal-property property">HooksDispatcherOnMount</span><span class="token operator">:</span> Dispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">useCallback</span><span class="token operator">:</span> mountCallback<span class="token punctuation">,</span>
  <span class="token literal-property property">useContext</span><span class="token operator">:</span> readContext<span class="token punctuation">,</span>
  <span class="token literal-property property">useEffect</span><span class="token operator">:</span> mountEffect<span class="token punctuation">,</span>
  <span class="token literal-property property">useImperativeHandle</span><span class="token operator">:</span> mountImperativeHandle<span class="token punctuation">,</span>
  <span class="token literal-property property">useLayoutEffect</span><span class="token operator">:</span> mountLayoutEffect<span class="token punctuation">,</span>
  <span class="token literal-property property">useMemo</span><span class="token operator">:</span> mountMemo<span class="token punctuation">,</span>
  <span class="token literal-property property">useReducer</span><span class="token operator">:</span> mountReducer<span class="token punctuation">,</span>
  <span class="token literal-property property">useRef</span><span class="token operator">:</span> mountRef<span class="token punctuation">,</span>
  <span class="token literal-property property">useState</span><span class="token operator">:</span> mountState<span class="token punctuation">,</span>
  <span class="token comment">// ...省略</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// update时的Dispatcher</span>
<span class="token keyword">const</span> <span class="token literal-property property">HooksDispatcherOnUpdate</span><span class="token operator">:</span> Dispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">useCallback</span><span class="token operator">:</span> updateCallback<span class="token punctuation">,</span>
  <span class="token literal-property property">useContext</span><span class="token operator">:</span> readContext<span class="token punctuation">,</span>
  <span class="token literal-property property">useEffect</span><span class="token operator">:</span> updateEffect<span class="token punctuation">,</span>
  <span class="token literal-property property">useImperativeHandle</span><span class="token operator">:</span> updateImperativeHandle<span class="token punctuation">,</span>
  <span class="token literal-property property">useLayoutEffect</span><span class="token operator">:</span> updateLayoutEffect<span class="token punctuation">,</span>
  <span class="token literal-property property">useMemo</span><span class="token operator">:</span> updateMemo<span class="token punctuation">,</span>
  <span class="token literal-property property">useReducer</span><span class="token operator">:</span> updateReducer<span class="token punctuation">,</span>
  <span class="token literal-property property">useRef</span><span class="token operator">:</span> updateRef<span class="token punctuation">,</span>
  <span class="token literal-property property">useState</span><span class="token operator">:</span> updateState<span class="token punctuation">,</span>
  <span class="token comment">// ...省略</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可见，<code>mount</code>时调用的<code>hook</code>和<code>update</code>时调用的<code>hook</code>其实是两个不同的函数。</p><p>在<code>FunctionComponent</code> <code>render</code>前，会根据<code>FunctionComponent</code>对应<code>fiber</code>的以下条件区分<code>mount</code>与<code>update</code>。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>current <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> current<span class="token punctuation">.</span>memoizedState <span class="token operator">===</span> <span class="token keyword">null</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>并将不同情况对应的<code>dispatcher</code>赋值给全局变量<code>ReactCurrentDispatcher</code>的<code>current</code>属性。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span>
      current <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> current<span class="token punctuation">.</span>memoizedState <span class="token operator">===</span> <span class="token keyword">null</span>
        <span class="token operator">?</span> HooksDispatcherOnMount
        <span class="token operator">:</span> HooksDispatcherOnUpdate<span class="token punctuation">;</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,11),m={href:"https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L409",target:"_blank",rel:"noopener noreferrer"},v=a("<p>在<code>FunctionComponent</code> <code>render</code>时，会从<code>ReactCurrentDispatcher.current</code>（即当前<code>dispatcher</code>）中寻找需要的<code>hook</code>。</p><p>换言之，不同的调用栈上下文为<code>ReactCurrentDispatcher.current</code>赋值不同的<code>dispatcher</code>，则<code>FunctionComponent</code> <code>render</code>时调用的<code>hook</code>也是不同的函数。</p>",2),h=e("code",null,"dispatcher",-1),b={href:"https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L1775",target:"_blank",rel:"noopener noreferrer"},y=e("code",null,"dispatcher",-1),f=a(`<h2 id="一个dispatcher使用场景" tabindex="-1"><a class="header-anchor" href="#一个dispatcher使用场景" aria-hidden="true">#</a> 一个dispatcher使用场景</h2><p>当错误的书写了嵌套形式的<code>hook</code>，如：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时<code>ReactCurrentDispatcher.current</code>已经指向<code>ContextOnlyDispatcher</code>，所以调用<code>useState</code>实际会调用<code>throwInvalidHookError</code>，直接抛出异常。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">ContextOnlyDispatcher</span><span class="token operator">:</span> Dispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">useCallback</span><span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  <span class="token literal-property property">useContext</span><span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  <span class="token literal-property property">useEffect</span><span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  <span class="token literal-property property">useImperativeHandle</span><span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  <span class="token literal-property property">useLayoutEffect</span><span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
  <span class="token comment">// ...省略</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,5),_={href:"https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L458",target:"_blank",rel:"noopener noreferrer"},g=a(`<h2 id="hook的数据结构" tabindex="-1"><a class="header-anchor" href="#hook的数据结构" aria-hidden="true">#</a> Hook的数据结构</h2><p>接下来我们学习<code>hook</code>的数据结构。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token literal-property property">hook</span><span class="token operator">:</span> Hook <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">memoizedState</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token literal-property property">baseState</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">baseQueue</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">queue</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3),C={href:"https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L546",target:"_blank",rel:"noopener noreferrer"},S=e("code",null,"hook",-1),w=e("code",null,"memoizedState",-1),x=a('<h2 id="memoizedstate" tabindex="-1"><a class="header-anchor" href="#memoizedstate" aria-hidden="true">#</a> memoizedState</h2><div class="hint-container warning"><p class="hint-container-title">注意</p><p><code>hook</code>与<code>FunctionComponent fiber</code>都存在<code>memoizedState</code>属性，不要混淆他们的概念。</p><ul><li><p><code>fiber.memoizedState</code>：<code>FunctionComponent</code>对应<code>fiber</code>保存的<code>Hooks</code>链表。</p></li><li><p><code>hook.memoizedState</code>：<code>Hooks</code>链表中保存的单一<code>hook</code>对应的数据。</p></li></ul></div><p>不同类型<code>hook</code>的<code>memoizedState</code>保存不同类型数据，具体如下：</p>',3),H=a("<li><p>useState：对于<code>const [state, updateState] = useState(initialState)</code>，<code>memoizedState</code>保存<code>state</code>的值</p></li><li><p>useReducer：对于<code>const [state, dispatch] = useReducer(reducer, {});</code>，<code>memoizedState</code>保存<code>state</code>的值</p></li>",2),R=e("code",null,"memoizedState",-1),j=e("code",null,"useEffect回调函数",-1),E=e("code",null,"依赖项",-1),z=e("code",null,"effect",-1),D={href:"https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L1181",target:"_blank",rel:"noopener noreferrer"},L=e("code",null,"effect",-1),I=e("code",null,"effect",-1),F=e("code",null,"fiber.updateQueue",-1),M=a("<li><p>useRef：对于<code>useRef(1)</code>，<code>memoizedState</code>保存<code>{current: 1}</code></p></li><li><p>useMemo：对于<code>useMemo(callback, [depA])</code>，<code>memoizedState</code>保存<code>[callback(), depA]</code></p></li><li><p>useCallback：对于<code>useCallback(callback, [depA])</code>，<code>memoizedState</code>保存<code>[callback, depA]</code>。与<code>useMemo</code>的区别是，<code>useCallback</code>保存的是<code>callback</code>函数本身，而<code>useMemo</code>保存的是<code>callback</code>函数的执行结果</p></li>",3),q=e("p",null,[n("有些"),e("code",null,"hook"),n("是没有"),e("code",null,"memoizedState"),n("的，比如：")],-1),O=e("ul",null,[e("li",null,"useContext")],-1);function N(V,A){const o=t("ExternalLinkIcon"),p=t("RouterLink");return r(),l("div",null,[k,d(" react17-alpha "),e("blockquote",null,[e("p",null,[n("你可以在"),e("a",m,[n("这里"),s(o)]),n("看到这行代码")])]),v,e("blockquote",null,[e("p",null,[n("除了这两个"),h,n("，你可以在"),e("a",b,[n("这里"),s(o)]),n("看到其他"),y,n("定义")])]),f,e("blockquote",null,[e("p",null,[n("你可以在"),e("a",_,[n("这里"),s(o)]),n("看到这段逻辑")])]),g,e("blockquote",null,[e("p",null,[n("你可以在"),e("a",C,[n("这里"),s(o)]),n("看到创建"),S,n("的逻辑")])]),e("p",null,[n("其中除"),w,n("以外字段的意义与上一章介绍的"),s(p,{to:"/views/Books/Front-end/JustReact/state/update.html#updatequeue"},{default:i(()=>[n("updateQueue")]),_:1}),n("类似。")]),x,e("ul",null,[H,e("li",null,[e("p",null,[n("useEffect："),R,n("保存包含"),j,n("、"),E,n("等的链表数据结构"),z,n("，你可以在"),e("a",D,[n("这里"),s(o)]),n("看到"),L,n("的创建过程。"),I,n("链表同时会保存在"),F,n("中")])]),M]),q,O])}const Q=c(u,[["render",N],["__file","structure.html.vue"]]);export{Q as default};

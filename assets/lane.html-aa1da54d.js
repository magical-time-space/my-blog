import{_ as t,X as c,Y as r,Z as s,$ as n,a0 as o,a4 as a,E as l}from"./framework-d8252107.js";const d={},i=a('<p>上一节我们提到<code>Scheduler</code>与<code>React</code>是两套<code>优先级</code>机制。在<code>React</code>中，存在多种使用不同<code>优先级</code>的情况，比如：</p><p>注：以下例子皆为<code>Concurrent Mode</code>开启情况</p><ul><li><p>过期任务或者同步任务使用<code>同步</code>优先级</p></li><li><p>用户交互产生的更新（比如点击事件）使用高优先级</p></li><li><p>网络请求产生的更新使用一般优先级</p></li><li><p><code>Suspense</code>使用低优先级</p></li></ul><p><code>React</code>需要设计一套满足如下需要的<code>优先级</code>机制：</p><ul><li><p>可以表示<code>优先级</code>的不同</p></li><li><p>可能同时存在几个同<code>优先级</code>的<code>更新</code>，所以还得能表示<code>批</code>的概念</p></li><li><p>方便进行<code>优先级</code>相关计算</p></li></ul><p>为了满足如上需求，<code>React</code>设计了<code>lane</code>模型。接下来我们来看<code>lane</code>模型如何满足以上3个条件。</p><h2 id="表示优先级的不同" tabindex="-1"><a class="header-anchor" href="#表示优先级的不同" aria-hidden="true">#</a> 表示优先级的不同</h2><p>想象你身处赛车场。</p>',8),k=["src"],u=a(`<p>不同的赛车疾驰在不同的赛道。内圈的赛道总长度更短，外圈更长。某几个临近的赛道的长度可以看作差不多长。</p><p><code>lane</code>模型借鉴了同样的概念，使用31位的二进制表示31条赛道，位数越小的赛道<code>优先级</code>越高，某些相邻的赛道拥有相同<code>优先级</code>。</p><p>如下：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">NoLanes</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> <span class="token comment">/*                        */</span> <span class="token number">0b0000000000000000000000000000000</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">NoLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                          */</span> <span class="token number">0b0000000000000000000000000000000</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">SyncLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                        */</span> <span class="token number">0b0000000000000000000000000000001</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">SyncBatchedLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                 */</span> <span class="token number">0b0000000000000000000000000000010</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">InputDiscreteHydrationLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*      */</span> <span class="token number">0b0000000000000000000000000000100</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token literal-property property">InputDiscreteLanes</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> <span class="token comment">/*                    */</span> <span class="token number">0b0000000000000000000000000011000</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token literal-property property">InputContinuousHydrationLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*           */</span> <span class="token number">0b0000000000000000000000000100000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token literal-property property">InputContinuousLanes</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> <span class="token comment">/*                  */</span> <span class="token number">0b0000000000000000000000011000000</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">DefaultHydrationLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*            */</span> <span class="token number">0b0000000000000000000000100000000</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">DefaultLanes</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> <span class="token comment">/*                   */</span> <span class="token number">0b0000000000000000000111000000000</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token literal-property property">TransitionHydrationLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                */</span> <span class="token number">0b0000000000000000001000000000000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token literal-property property">TransitionLanes</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> <span class="token comment">/*                       */</span> <span class="token number">0b0000000001111111110000000000000</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token literal-property property">RetryLanes</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> <span class="token comment">/*                            */</span> <span class="token number">0b0000011110000000000000000000000</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">SomeRetryLane</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> <span class="token comment">/*                  */</span> <span class="token number">0b0000010000000000000000000000000</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">SelectiveHydrationLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*          */</span> <span class="token number">0b0000100000000000000000000000000</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> NonIdleLanes <span class="token operator">=</span> <span class="token comment">/*                                 */</span> <span class="token number">0b0000111111111111111111111111111</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">IdleHydrationLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*               */</span> <span class="token number">0b0001000000000000000000000000000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token literal-property property">IdleLanes</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> <span class="token comment">/*                             */</span> <span class="token number">0b0110000000000000000000000000000</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">OffscreenLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                   */</span> <span class="token number">0b1000000000000000000000000000000</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,4),m={href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberLane.js#L77-L107",target:"_blank",rel:"noopener noreferrer"},v=s("code",null,"lane",-1),b=a(`<p>其中，同步优先级占用的赛道为第一位：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">SyncLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                        */</span> <span class="token number">0b0000000000000000000000000000001</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>从<code>SyncLane</code>往下一直到<code>SelectiveHydrationLane</code>，赛道的<code>优先级</code>逐步降低。</p><h2 id="表示-批-的概念" tabindex="-1"><a class="header-anchor" href="#表示-批-的概念" aria-hidden="true">#</a> 表示“批”的概念</h2><p>可以看到其中有几个变量占用了几条赛道，比如：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token literal-property property">InputDiscreteLanes</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> <span class="token comment">/*                    */</span> <span class="token number">0b0000000000000000000000000011000</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">DefaultLanes</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> <span class="token comment">/*                   */</span> <span class="token number">0b0000000000000000000111000000000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token literal-property property">TransitionLanes</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> <span class="token comment">/*                       */</span> <span class="token number">0b0000000001111111110000000000000</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这就是<code>批</code>的概念，被称作<code>lanes</code>（区别于<code>优先级</code>的<code>lane</code>）。</p><p>其中<code>InputDiscreteLanes</code>是“用户交互”触发更新会拥有的<code>优先级</code>范围。</p><p><code>DefaultLanes</code>是“请求数据返回后触发更新”拥有的<code>优先级</code>范围。</p><p><code>TransitionLanes</code>是<code>Suspense</code>、<code>useTransition</code>、<code>useDeferredValue</code>拥有的<code>优先级</code>范围。</p><p>这其中有个细节，越低<code>优先级</code>的<code>lanes</code>占用的位越多。比如<code>InputDiscreteLanes</code>占了2个位，<code>TransitionLanes</code>占了9个位。</p><p>原因在于：越低<code>优先级</code>的<code>更新</code>越容易被打断，导致积压下来，所以需要更多的位。相反，最高优的同步更新的<code>SyncLane</code>不需要多余的<code>lanes</code>。</p><h2 id="方便进行优先级相关计算" tabindex="-1"><a class="header-anchor" href="#方便进行优先级相关计算" aria-hidden="true">#</a> 方便进行优先级相关计算</h2><p>既然<code>lane</code>对应了二进制的位，那么<code>优先级</code>相关计算其实就是位运算。</p><p>比如：</p><p>计算<code>a</code>、<code>b</code>两个<code>lane</code>是否存在交集，只需要判断<code>a</code>与<code>b</code>按位与的结果是否为<code>0</code>：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">includesSomeLane</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">a</span><span class="token operator">:</span> Lanes <span class="token operator">|</span> Lane<span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> Lanes <span class="token operator">|</span> Lane</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>a <span class="token operator">&amp;</span> b<span class="token punctuation">)</span> <span class="token operator">!==</span> NoLanes<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>计算<code>b</code>这个<code>lanes</code>是否是<code>a</code>对应的<code>lanes</code>的子集，只需要判断<code>a</code>与<code>b</code>按位与的结果是否为<code>b</code>：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isSubsetOfLanes</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">set</span><span class="token operator">:</span> Lanes<span class="token punctuation">,</span> <span class="token literal-property property">subset</span><span class="token operator">:</span> Lanes <span class="token operator">|</span> Lane</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>set <span class="token operator">&amp;</span> subset<span class="token punctuation">)</span> <span class="token operator">===</span> subset<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将两个<code>lane</code>或<code>lanes</code>的位合并只需要执行按位或操作：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">a</span><span class="token operator">:</span> Lanes <span class="token operator">|</span> Lane<span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> Lanes <span class="token operator">|</span> Lane</span><span class="token punctuation">)</span><span class="token operator">:</span> Lanes <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">|</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从<code>set</code>对应<code>lanes</code>中移除<code>subset</code>对应<code>lane</code>（或<code>lanes</code>），只需要对<code>subset</code>的<code>lane</code>（或<code>lanes</code>）执行按位非，结果再对<code>set</code>执行按位与。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">removeLanes</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">set</span><span class="token operator">:</span> Lanes<span class="token punctuation">,</span> <span class="token literal-property property">subset</span><span class="token operator">:</span> Lanes <span class="token operator">|</span> Lane</span><span class="token punctuation">)</span><span class="token operator">:</span> Lanes <span class="token punctuation">{</span>
  <span class="token keyword">return</span> set <span class="token operator">&amp;</span> <span class="token operator">~</span>subset<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,23),y={href:"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Bitwise_Operators",target:"_blank",rel:"noopener noreferrer"},L=a('<h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>这就是<code>React</code>的优先级模型<code>lane</code>模型。</p><p>至此，我们已经了解<code>Fiber</code>架构、<code>更新</code>的<code>优先级</code>、<code>Scheduler</code>的实现、<code>lane</code>模型。从下一节开始，我们会逐步讲解<code>Concurrent Mode</code>的各种应用。</p>',3);function h(p,w){const e=l("ExternalLinkIcon");return c(),r("div",null,[i,s("img",{src:p.$withBase("/img/lane.jpeg"),alt:"30sec"},null,8,k),u,s("blockquote",null,[s("p",null,[n("你可以在"),s("a",m,[n("这里"),o(e)]),n("看到"),v,n("的定义")])]),b,s("blockquote",null,[s("p",null,[n("更多位运算参考"),s("a",y,[n("MDN"),o(e)])])]),L])}const f=t(d,[["render",h],["__file","lane.html.vue"]]);export{f as default};

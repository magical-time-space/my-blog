import{_ as n,X as s,Y as a,a4 as t}from"./framework-d8252107.js";const e={},p=t(`<h1 id="扫描器" tabindex="-1"><a class="header-anchor" href="#扫描器" aria-hidden="true">#</a> 扫描器</h1><p>TypeScript 扫描器的源码均位于 <code>scanner.ts</code>。在内部，由解析器<em>控制</em>扫描器将源码转化为抽象语法树（AST）。期望结果如下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>SourceCode ~~ 扫描器 ~~&gt; Token 流 ~~ 解析器 ~~&gt; AST
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="解析器对扫描器的使用" tabindex="-1"><a class="header-anchor" href="#解析器对扫描器的使用" aria-hidden="true">#</a> 解析器对扫描器的使用</h2><p>为避免重复创建扫描器造成的开销，<code>parser.ts</code> 中创建了一个扫描器的<em>单例</em>。解析器根据需要使用 <code>initializeState</code> 函数<em>准备</em>该扫描器。</p><p>下面是解析器中的实际代码的简化版，你可以运行它演示以上概念</p><p><code>code/compiler/scanner/runScanner.ts</code></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> ts <span class="token keyword">from</span> <span class="token string">&#39;ntypescript&#39;</span><span class="token punctuation">;</span>

<span class="token comment">// 单例扫描器</span>
<span class="token keyword">const</span> scanner <span class="token operator">=</span> ts<span class="token punctuation">.</span><span class="token function">createScanner</span><span class="token punctuation">(</span>ts<span class="token punctuation">.</span>ScriptTarget<span class="token punctuation">.</span>Latest<span class="token punctuation">,</span> <span class="token comment">/* 忽略杂项 */</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 此函数与初始化使用的 \`initializeState\` 函数相似</span>
<span class="token keyword">function</span> <span class="token function">initializeState</span><span class="token punctuation">(</span>text<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  scanner<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
  scanner<span class="token punctuation">.</span><span class="token function">setOnError</span><span class="token punctuation">(</span><span class="token punctuation">(</span>message<span class="token operator">:</span> ts<span class="token punctuation">.</span>DiagnosticMessage<span class="token punctuation">,</span> length<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scanner<span class="token punctuation">.</span><span class="token function">setScriptTarget</span><span class="token punctuation">(</span>ts<span class="token punctuation">.</span>ScriptTarget<span class="token punctuation">.</span><span class="token constant">ES5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scanner<span class="token punctuation">.</span><span class="token function">setLanguageVariant</span><span class="token punctuation">(</span>ts<span class="token punctuation">.</span>LanguageVariant<span class="token punctuation">.</span>Standard<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用示例</span>
<span class="token function">initializeState</span><span class="token punctuation">(</span>
  <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">
var foo = 123;
</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 开始扫描</span>
<span class="token keyword">var</span> token <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>token <span class="token operator">!=</span> ts<span class="token punctuation">.</span>SyntaxKind<span class="token punctuation">.</span>EndOfFileToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ts<span class="token punctuation">.</span><span class="token function">formatSyntaxKind</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  token <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>该段代码输出以下内容：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>VarKeyword
Identifier
FirstAssignment
FirstLiteralToken
SemicolonToken
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="扫描器状态" tabindex="-1"><a class="header-anchor" href="#扫描器状态" aria-hidden="true">#</a> 扫描器状态</h2><p>调用 <code>scan</code> 后，扫描器更新其局部状态（扫描位置，当前 token 详情等）。扫描器提供了一组工具函数获取当前扫描器状态。下例中，我们创建一个扫描器并用它识别 token 以及 token 在代码中的位置。</p><p><code>code/compiler/scanner/runScannerWithPosition.ts</code></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 使用示例</span>
<span class="token function">initializeState</span><span class="token punctuation">(</span>
  <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">
var foo = 123;
</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 开始扫描</span>
<span class="token keyword">var</span> token <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>token <span class="token operator">!=</span> ts<span class="token punctuation">.</span>SyntaxKind<span class="token punctuation">.</span>EndOfFileToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> currentToken <span class="token operator">=</span> ts<span class="token punctuation">.</span><span class="token function">formatSyntaxKind</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> tokenStart <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">getStartPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  token <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> tokenEnd <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">getStartPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>currentToken<span class="token punctuation">,</span> tokenStart<span class="token punctuation">,</span> tokenEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>该代码输出以下内容：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>VarKeyword 0 3
Identifier 3 7
FirstAssignment 7 9
FirstLiteralToken 9 13
SemicolonToken 13 14
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="独立扫描器" tabindex="-1"><a class="header-anchor" href="#独立扫描器" aria-hidden="true">#</a> 独立扫描器</h2><p>即便 TypeScript 解析器有单例扫描器，你仍可以使用 <code>createScanner</code> 创建独立的扫描器，然后可以用 <code>setText</code>/<code>setTextPos</code> 随意扫描文件的不同位置。</p>`,18),c=[p];function o(i,l){return s(),a("div",null,c)}const r=n(e,[["render",o],["__file","scanner.html.vue"]]);export{r as default};
